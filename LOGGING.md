# üìä –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è CRM

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –î–æ—Å—Ç—É–ø –∫ Grafana
- **URL**: http://localhost:3001
- **–õ–æ–≥–∏–Ω**: `admin`
- **–ü–∞—Ä–æ–ª—å**: `stage-una-crm-ru-2024`

### –î–æ—Å—Ç—É–ø –∫ Loki API
- **URL**: http://localhost:3100

## üìã –ß—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ

### 1. **Loki** - –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä –ª–æ–≥–æ–≤
- –°–æ–±–∏—Ä–∞–µ—Ç –ª–æ–≥–∏ —Å–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –•—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
- Retention: 31 –¥–µ–Ω—å (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `config/loki/local-config.yaml`)

### 2. **Promtail** - –°–±–æ—Ä—â–∏–∫ –ª–æ–≥–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –ª–æ–≥–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –ü–∞—Ä—Å–∏—Ç JSON –ª–æ–≥–∏
- –î–æ–±–∞–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (container_name, image_name, etc.)

### 3. **Grafana** - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
- –î–∞—à–±–æ—Ä–¥ "CRM System Logs" —Å –ø–∞–Ω–µ–ª—è–º–∏:
  - –í—Å–µ –ª–æ–≥–∏ CRM —Å–∏—Å—Ç–µ–º—ã
  - –û—à–∏–±–∫–∏ (—Å–æ–¥–µ—Ä–∂–∞—â–∏–µ "error")
  - HTTP –æ—à–∏–±–∫–∏ (400, 401, 403, 404, 500)

## üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ Grafana Explore

### –ë–∞–∑–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:
```logql
# –í—Å–µ –ª–æ–≥–∏
{namespace="stage-una-crm-ru"}

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
{namespace="stage-una-crm-ru"} |= "error"

# HTTP –æ—à–∏–±–∫–∏
{namespace="stage-una-crm-ru"} |= "400" | "401" | "403" | "404" | "500"

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
{container_name="crm_backend"}

# –õ–æ–≥–∏ –ø–æ —É—Ä–æ–≤–Ω—é
{level="error"}
```

### –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É:
```logql
# –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é
{namespace="stage-una-crm-ru"} |= "database connection"

# –ò—Å–∫–ª—é—á–µ–Ω–∏–µ
{namespace="stage-una-crm-ru"} != "debug"

# –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
{namespace="stage-una-crm-ru"} |~ ".*error.*"
```

### –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:
```logql
# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
{namespace="stage-una-crm-ru"} [5m]

# –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
{namespace="stage-una-crm-ru"} [1h]
```

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
docker-compose up -d loki grafana promtail

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
docker-compose stop loki grafana promtail

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose restart loki grafana promtail
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:
```bash
# –õ–æ–≥–∏ Loki
docker-compose logs loki

# –õ–æ–≥–∏ Promtail
docker-compose logs promtail

# –õ–æ–≥–∏ Grafana
docker-compose logs grafana
```

### –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
```bash
# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ª–æ–≥–æ–≤
docker-compose down
docker volume rm crm-system-dev_loki_data
docker volume rm crm-system-dev_grafana_data
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
config/
‚îú‚îÄ‚îÄ loki/
‚îÇ   ‚îî‚îÄ‚îÄ local-config.yaml      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Loki
‚îú‚îÄ‚îÄ promtail/
‚îÇ   ‚îî‚îÄ‚îÄ config.yml             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Promtail
‚îî‚îÄ‚îÄ grafana/
    ‚îî‚îÄ‚îÄ provisioning/
        ‚îú‚îÄ‚îÄ datasources/
        ‚îÇ   ‚îî‚îÄ‚îÄ loki.yml       # Datasource Loki
        ‚îî‚îÄ‚îÄ dashboards/
            ‚îú‚îÄ‚îÄ dashboard.yml  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–æ–≤
            ‚îî‚îÄ‚îÄ crm-logs.json  # –î–∞—à–±–æ—Ä–¥ CRM
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retention

–í `config/loki/local-config.yaml`:
```yaml
limits_config:
  retention_period: 744h  # 31 –¥–µ–Ω—å
```

## üö® –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è:
```bash
# Loki
curl http://localhost:3100/ready

# Grafana
curl http://localhost:3001/api/health
```

### –ú–µ—Ç—Ä–∏–∫–∏:
- **Loki**: http://localhost:3100/metrics
- **Promtail**: http://localhost:9080/metrics

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö**:
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON –ª–æ–≥–∏ –≤ backend
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ frontend
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ telegram bot

2. **–ê–ª–µ—Ä—Ç—ã**:
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram/Slack

3. **–ú–µ—Ç—Ä–∏–∫–∏**:
   - –î–æ–±–∞–≤–∏—Ç—å Prometheus –¥–ª—è –º–µ—Ç—Ä–∏–∫
   - –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥—ã —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏

4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è Grafana
   - –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∞–º
